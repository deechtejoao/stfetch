#!/usr/bin/env bash
set -euo pipefail

readonly RED=$'\e[31m'
readonly GREEN=$'\e[32m'
readonly YELLOW=$'\e[33m'
readonly BLUE=$'\e[34m'
readonly BOLD=$'\e[1m'
readonly RESET=$'\e[0m'

INPUT="${*}"

resolve_appid() {
  local name_encoded search_html appid
  name_encoded="${1// /+}"
  name_encoded="${name_encoded//[^[:alnum:]+]/}"
  search_html=$(curl -fsSL "https://store.steampowered.com/search/?term=${name_encoded}&category1=998")
  appid=$(grep -oP 'data-ds-appid="\K[0-9]+' <<<"${search_html}" | head -n1)
  [[ -n "$appid" ]] || { printf '%s%sError:%s Could not resolve AppID for %s\n' "$RED" "$BOLD" "$RESET" "$1" >&2; exit 1; }
  printf '%s' "$appid"
}

if [[ "$INPUT" =~ ^[0-9]+$ ]]; then
  APPID="$INPUT"
else
  APPID=$(resolve_appid "$INPUT")
fi

API_URL="https://store.steampowered.com/api/appdetails?appids=${APPID}&cc=us&l=en"
response=$(curl -fsSL "$API_URL")

jq -e --arg id "$APPID" '.[$id].success' <<<"$response" >/dev/null \
  || { printf '%s%sError:%s Could not retrieve data for AppID %s\n' "$RED" "$BOLD" "$RESET" "$APPID" >&2; exit 1; }

name=$(jq -r --arg id "$APPID" '.[$id].data.name' <<<"$response")
release_date=$(jq -r --arg id "$APPID" '.[$id].data.release_date.date' <<<"$response")
is_free=$(jq -r --arg id "$APPID" '.[$id].data.is_free' <<<"$response")

if [[ "$is_free" == true ]]; then
  price='Free to Play'
else
  price=$(jq -r --arg id "$APPID" '.[$id].data.price_overview.final_formatted' <<<"$response")
fi

if jq -e --arg id "$APPID" '.[$id].data.metacritic.score' <<<"$response" >/dev/null; then
  meta_score=$(jq -r --arg id "$APPID" '.[$id].data.metacritic.score' <<<"$response")
  reviews="Metacritic Score: ${meta_score}"
else
  reviews='No Metacritic data'
fi

printf '%s%sSteam App ID:%s %s\n' "$BLUE" "$BOLD" "$RESET" "$APPID"
printf '%s%sTitle       :%s %s\n' "$GREEN" "$BOLD" "$RESET" "$name"
printf '%s%sRelease Date:%s %s\n' "$YELLOW" "$BOLD" "$RESET" "$release_date"
printf '%s%sPrice       :%s %s\n' "$BLUE" "$BOLD" "$RESET" "$price"
printf '%s%sReviews     :%s %s\n' "$GREEN" "$BOLD" "$RESET" "$reviews"

